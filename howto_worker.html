<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>How To Run a Worker - The SubstraTEE Book</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div id="sidebar-scrollbox" class="sidebar-scrollbox">
                <ol class="chapter"><li class="expanded affix "><a href="introduction.html">Introduction</a></li><li class="expanded "><a href="trusted_execution.html"><strong aria-hidden="true">1.</strong> What is Trusted Execution?</a></li><li><ol class="section"><li class="expanded "><a href="remote_attestation.html"><strong aria-hidden="true">1.1.</strong> Remote Attestation</a></li></ol></li><li class="expanded "><a href="what_for.html"><strong aria-hidden="true">2.</strong> What is SubstraTEE Good For?</a></li><li><ol class="section"><li class="expanded "><a href="privacy.html"><strong aria-hidden="true">2.1.</strong> Privacy</a></li><li class="expanded "><a href="scalability.html"><strong aria-hidden="true">2.2.</strong> Scalability</a></li><li class="expanded "><a href="interoperability.html"><strong aria-hidden="true">2.3.</strong> Interoperability</a></li><li class="expanded "><a href="use_case_cdn.html"><strong aria-hidden="true">2.4.</strong> CDN</a></li></ol></li><li class="expanded "><a href="design.html"><strong aria-hidden="true">3.</strong> Design</a></li><li><ol class="section"><li class="expanded "><a href="sharding.html"><strong aria-hidden="true">3.1.</strong> Sharding</a></li><li class="expanded "><a href="token_shielding.html"><strong aria-hidden="true">3.2.</strong> Token Shielding</a></li><li class="expanded "><a href="security.html"><strong aria-hidden="true">3.3.</strong> Security</a></li><li class="expanded "><a href="benchmarks.html"><strong aria-hidden="true">3.4.</strong> Benchmarks</a></li></ol></li><li class="expanded "><a href="howto.html"><strong aria-hidden="true">4.</strong> Howto</a></li><li><ol class="section"><li class="expanded "><a href="howto_node.html"><strong aria-hidden="true">4.1.</strong> How To Run a Node</a></li><li class="expanded "><a href="howto_worker.html" class="active"><strong aria-hidden="true">4.2.</strong> How To Run a Worker</a></li><li class="expanded "><a href="howto_private_tx.html"><strong aria-hidden="true">4.3.</strong> How To Perform a Private Transaction</a></li><li class="expanded "><a href="howto_access_onchain_storage.html"><strong aria-hidden="true">4.4.</strong> How To Access On-Chain Storage Trustlessly</a></li><li class="expanded "><a href="howto_stf.html"><strong aria-hidden="true">4.5.</strong> How To Build Your Own Trusted STF</a></li></ol></li><li class="expanded "><a href="roadmap.html"><strong aria-hidden="true">5.</strong> Roadmap</a></li><li class="expanded "><a href="glossary.html"><strong aria-hidden="true">6.</strong> Glossary</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">The SubstraTEE Book</h1>

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#how-to-run-your-own-worker" id="how-to-run-your-own-worker">How To Run Your Own Worker</a></h1>
<h2><a class="header" href="#hw-requirements" id="hw-requirements">HW requirements</a></h2>
<p>While SGX is supported by most Intel CPU's that is not the case for all chipsets. Here we're just telling you what HW we are using and is known to work.</p>
<h3><a class="header" href="#dell-poweredge-r340-server" id="dell-poweredge-r340-server">Dell PowerEdge R340 Server</a></h3>
<p>CPU <strong>has to be</strong> Intel(R) Xeon(R) E-2276G CPU @ 3.80 GHz</p>
<h3><a class="header" href="#enable-sgx-support-in-bios" id="enable-sgx-support-in-bios">Enable SGX support in BIOS</a></h3>
<p>To enable SGX support in the Dell BIOS, enter the BIOS, go to <code>System Security</code> and set the following values:</p>
<ul>
<li><code>Intel SGX</code> to <code>On</code></li>
<li><code>SGX Launch Control Policy</code> to <code>Unlocked</code></li>
</ul>
<h2><a class="header" href="#intel-sgx-development-and-production-commercial-license" id="intel-sgx-development-and-production-commercial-license">Intel SGX development and production (commercial) license</a></h2>
<p>In order to perform a remote attestation of the enclave, an <a href="https://api.portal.trustedservices.intel.com/EPID-attestation">Intel SGX Attestation Enhanced Service Privacy ID (EPID)</a> is needed. We use unlinkable quotes in our code. Developers need to <a href="https://software.intel.com/en-us/form/sgx-onboarding">register an account with Intel</a></p>
<h3><a class="header" href="#development-access" id="development-access">Development Access</a></h3>
<p>Copy your SPID and key to the following files (use Linux line endings):</p>
<ul>
<li><code>bin/spid.txt</code>: SPID of your subscription</li>
<li><code>bin/key.txt</code>: Key of your subscription (primary or secondary works)</li>
</ul>
<p>The enclave will be signed with the development key found under <code>enclave/Enclave_private.pem</code> and uses the configuration found under <code>enclave/Enclave.config.xml</code>.</p>
<h3><a class="header" href="#production-access" id="production-access">Production Access</a></h3>
<p>You need a commercial license with Intel to run your enclaves in production mode (the only mode that really is confidential). Only legal entities can get a commercial license with Intel. Get in touch with them to obtain one.</p>
<p>Copy your SPID and key to the following files (use Linux line endings):</p>
<ul>
<li><code>bin/spid_production.txt</code>: SPID of your subscription</li>
<li><code>bin/key_production.txt</code>: Key of your subscription (primary or secondary works)</li>
</ul>
<p>These files are used to access the Intel Remote Attestation Service.</p>
<p>The enclave will be signed with the private key that was also registered and whitelisted at Intel's (in the process of obtaining a commercial license). Make sure that the key is exported as an environment variable called <code>SGX_COMMERCIAL_KEY</code>.</p>
<p>The enclave in production mode uses the configuration found under <code>enclave/Enclave.config.production.xml</code>.</p>
<p>The only difference is that the option <code>DisableDebug</code> is set to <code>1</code>.</p>
<h2><a class="header" href="#sw-requirements" id="sw-requirements">SW Requirements</a></h2>
<p>You need the following components installed to start developing/compiling the code:</p>
<ul>
<li><a href="https://github.com/intel/linux-sgx-driver">Intel SGX driver</a>, <a href="https://github.com/intel/linux-sgx">SGX and PSW</a></li>
<li><a href="https://www.rust-lang.org/">Rust</a></li>
<li><a href="https://github.com/apache/incubator-teaclave-sgx-sdk">Rust SGX SDK</a></li>
<li><a href="https://ipfs.io/">IPFS</a></li>
</ul>
<h3><a class="header" href="#setup-worker-with-ansible" id="setup-worker-with-ansible">Setup Worker with Ansible</a></h3>
<p>You find a sample Ansible playbook under https://github.com/scs/intel_sgx_setup.</p>
<p>Open the playbook with your editor and replace all the variables with <code>&lt;...&gt;</code> with your own settings.</p>
<p>To execute the playbook and configure the remote machine, use the following command:</p>
<pre><code class="language-bash">ansible-playbook site.yml -k
</code></pre>
<h2><a class="header" href="#build-worker" id="build-worker">Build Worker</a></h2>
<pre><code class="language-bash">git clone https://github.com/scs/substraTEE-worker.git
cd substraTEE-worker
make
</code></pre>
<p>this might take 10min+ on a fast machine.</p>
<p>then you'll have to provide your SPID and KEY (see above)</p>
<pre><code class="language-bash">echo &quot;&lt;YOUR SPID&gt;&quot; &gt; bin/spid.txt
echo &quot;&lt;YOUR KEY&gt;&quot; &gt; bin/key.txt
</code></pre>
<h2><a class="header" href="#run-worker" id="run-worker">Run Worker</a></h2>
<pre><code class="language-bash">cd bin
./substratee-worker init-shard
./substratee-worker shielding-key
./substratee-worker signing-key
./substratee-worker run --ns &lt;yournodeip&gt;
</code></pre>
<h2><a class="header" href="#using-docker" id="using-docker">Using Docker</a></h2>
<p>We provide docker images with all the required tools installed. They can be found on <a href="https://hub.docker.com/repository/docker/scssubstratee/substratee_dev">dockerhub</a>.</p>
<p>The tag has the following format: <code>&lt;Ubuntu version&gt;-&lt;Intel SGX SDK version&gt;-&lt;Rust SGX SDK version&gt;</code>. We don't provide any <em>latest</em> so you must specify the tag.</p>
<p>If you execute</p>
<pre><code class="language-bash">docker pull scssubstratee/substratee_dev:18.04-2.9.1-1.1.2
</code></pre>
<p>you get a docker image with</p>
<ul>
<li>Ubuntu 18.04</li>
<li>Intel SGX SDK 2.9.1</li>
<li>Rust SGX SDK 1.1.2 (which includes the correct Rust version)</li>
<li>IPFS 0.4.21</li>
</ul>
<p>The following builds the code inside the docker, but the compiled binaries are stored on your local working copy.</p>
<pre><code class="language-bash">docker run -it -v $(pwd):/root/work scssubstratee/substratee_dev:18.04-2.9.1-1.1.2 /bin/bash
</code></pre>
<p>Now you can build and run your worker inside docker. Just replace the make command above with</p>
<pre><code class="language-bash">SGX_MODE=SW make
</code></pre>
<p>to run in <a href="https://software.intel.com/en-us/blogs/2016/05/30/usage-of-simulation-mode-in-sgx-enhanced-application">Simulation Mode</a> without the need of an actual SGX platform. You will not be able to perform remote attestation in SW mode</p>
<h3><a class="header" href="#enabling-sgx-hw-support-in-docker" id="enabling-sgx-hw-support-in-docker">Enabling SGX HW Support in Docker</a></h3>
<p>If you are on a platform that supports SGX, you can enable HW support by:</p>
<ul>
<li>
<p>Installing the Intel SGX Driver 2.9 and make sure that <code>/dev/isgx</code> appears</p>
</li>
<li>
<p>Start the docker with SGX device support:</p>
<pre><code class="language-bash">docker run -it -v $(pwd):/root/work --device /dev/isgx scssubstratee/substratee_dev:18.04-2.9.1-1.1.2 /bin/bash
</code></pre>
</li>
<li>
<p>Start the aesm service inside the docker:</p>
<pre><code class="language-bash">LD_LIBRARY_PATH=/opt/intel/sgx-aesm-service/aesm/ /opt/intel/sgx-aesm-service/aesm/aesm_service &amp;
</code></pre>
</li>
<li>
<p>Compile the substraTEE-worker with HW support:</p>
<pre><code class="language-bash">make
</code></pre>
</li>
<li>
<p>run worker like described above</p>
</li>
</ul>
<p>If you run the Hardware Mode on a platform that does not support SGX, you get the following error from the substraTEE-worker</p>
<pre><code class="language-bash">*** Start the enclave
[2019-05-15T05:15:03Z ERROR substratee_worker::enclave_wrappers] [-] Init Enclave Failed SGX_ERROR_NO_DEVICE!
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="howto_node.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="howto_private_tx.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="howto_node.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="howto_private_tx.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
